# Wazuh Agent Enrollment from CLI - Version 4.14.3
---

## Prerequisites
**Ensure communication and security as enrollment fails due to network blocks or mismatches.**

- Manager Accessibility: Endpoint must reach manager IP/FQDN (YOUR-DEBIAN-IP) over network. Agent sends registration request to manager on TCP port 1514 and reports logs on TCP port 1515.
- Endpoint OS: Linux or Windows.Agent software is OS-specific, wrong OS causes install failure.
- Admin Access: Root/sudo on Linux endpoint, Admin on Windows endpoint.
- Version Match: Both manager and agent must be 4.14.3. Check manager version: sudo /var/ossec/bin/wazuh-control info.

## Add Agent & Extract Key
### Manager stores agent metadata in /var/ossec/etc/client.keys, key is encrypted hash for mutual authentication**

**Add agent:**
```
sudo /var/ossec/bin /manage_agents -a "TARGET-ENDPOINT-IP" -n "TARGET-ENDPOINT-HOSTNAME"
# Example: sudo /var/ossec/bin /manage_agents -a "10.10.10.10" -n "windows-pc-01"
```
**Check if agent created and the agent ID**
```
sudo /var/ossec/bin/agent_control -l
```
**Extract key:**
```
sudo ./manage_agents -e AGENT-ID
# Example: sudo ./manage_agents -e 001
```
- Output: Full key string (e.g., "MDAwMSBsaW51eC1lbmRwb2ludC0wMSBhbnkgMzllNT...=").Copy the key exactly, including equals sign/s.

## Optional but recommended -  Create groups for agents and assign them accordingly.

**Create group**
```
sudo ./agent_groups -a -g "WindowsPC-Prod"
```

**Add agent to group**
```
sudo /var/ossec/bin/agent_groups -a -i 001 -g "WindowsPC-Prod"
```

**Remove agent from previous assigned grou**
```
 sudo  /var/ossec/bin/agent_groups -r -g default -i 001
```

## Install Agent on Endpoint

## Windows:
- Download MSI: https://packages.wazuh.com/4.x/windows/wazuh-agent-4.14.3-1.msi
- Run as admin terminal:
```
 msiexec.exe /i wazuh-agent-4.14.3-1.msi /q WAZUH_MANAGER="YOUR-DEBIAN-IP"
```
- Verify at Services.msc that WazuhSvc running.

### Enroll Agent - Establish Connection

- Navigate to agent's installation path and run termianl as admin:
```
cd "C:\Program Files (x86)\ossec-agent"

.\manage_agents.exe -i "EXTRACTED-KEY"
```
- Restart WazuhSvc service
- Verify communication on manager
```
sudo /var/ossec/bin/agent_control -l
```
- You should see agent Active.
---
---

## Linux Debian/Ubuntu:
Add Wazuh GPG key:
```
curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | sudo apt-key add -
```
Add Wazuh repository:
```
echo "deb https://packages.wazuh.com/4.x/apt/ stable main" | sudo tee /etc/apt/sources.list.d/wazuh.list.
```
Update/install agent:
```
sudo apt update && sudo apt install wazuh-agent=4.14.3-1 -y
```
Import key:
```
sudo /var/ossec/bin/manage_agents -i "EXTRACTED-KEY"
```
Restart agent:
```
sudo systemctl restart wazuh-agent
```

## Troubleshooting

- Key Error "Invalid key" - Regenerate/extract again.Key is base64-like, corruption fails hash check.
- Pending Agent, Status "Never connected" â€“ Restart agent/manager (sudo /var/ossec/bin/wazuh-control restart on manager).Restart resends registration.
- Version Mismatch - Check both with wazuh-control info.
- No Alerts in Elastic - Trigger a test and check manager /var/ossec/logs/alerts/alerts.json.Check Vector logs for parsing errors.






