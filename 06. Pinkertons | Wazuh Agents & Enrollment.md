# Wazuh Agent Enrollment from CLI - Version 4.14.3
---

## Prerequisites
**Ensure communication and security as enrollment fails due to network blocks or mismatches.**

- Manager Accessibility: Endpoint must reach manager IP/FQDN (e.g., YOUR-DEBIAN-IP) over network. Agent sends registration request to manager on TCP 1514 and reports logs on TCP 1515.
- Endpoint OS: Linux or Windows.Agent software is OS-specific, wrong OS causes install failure.
- Admin Access: Root/sudo on Linux manager/endpoint, Admin on Windows.Istallation edits system files/services, requiring elevated privileges.
- Version Match: Both manager/agent must be 4.14.3. Check manager version: sudo /var/ossec/bin/wazuh-control info.

## Add Agent & Extract Key
### Manager stores agent metadata in /var/ossec/etc/client.keys, key is encrypted hash for mutual authentication**

**Add agent:**
```
sudo /var/ossec/bin /manage_agents -a "TARGET-ENDPOINT-IP" -n "TARGET-ENDPOINT-HOSTNAME"
# Example: sudo /var/ossec/bin /manage_agents -a "10.10.10.10" -n "windows-pc-01"
```
**Check if agent created and the agent ID**
```
sudo /var/ossec/bin/agent_control -l
```
**Extract key:**
```
sudo ./manage_agents -e AGENT-ID
# Example: sudo ./manage_agents -e 001
```
- Output: Full key string (e.g., "MDAwMSBsaW51eC1lbmRwb2ludC0wMSBhbnkgMzllNT...=").Copy the key exactly, including equals sign/s.

## Optional but recommended -  Create groups for agents and assign them accordingly.

**Create group**
```
sudo ./agent_groups -a -g "WindowsPC-Prod"
```

**Add agent to group**
```
sudo /var/ossec/bin/agent_groups -a -i 001 -g "WindowsPC-Prod"
```

**Remove agent from previous assigned grou**
```
 sudo  /var/ossec/bin/agent_groups -r -g default -i 001
```

## Install Agent on Endpoint

**Windows:**
- Download MSI: https://packages.wazuh.com/4.x/windows/wazuh-agent-4.14.3-1.msi
- 
Run as admin terminal:
```
 msiexec.exe /i wazuh-agent-4.14.3-1.msi /q WAZUH_MANAGER="YOUR-DEBIAN-IP"
```
- Verify: Services.msc → WazuhSvc running.

## Enroll Agent - Establish Connection

Navigate to agent's installation path and run termianl as admin:
```
cd "C:\Program Files (x86)\ossec-agent"

.\manage_agents.exe -i "EXTRACTED-KEY"
```
- Restart WazuhSvc service
- Verify communication on manager
```
sudo /var/ossec/bin/agent_control -l
```
You should see Active.

## Troubleshooting

- Key Error "Invalid key" - Regenerate/extract again.Key is base64-like, corruption fails hash check.
- Pending Agent, Status "Never connected" – Restart agent/manager (sudo /var/ossec/bin/wazuh-control restart on manager).Restart resends registration.
- Version Mismatch - Check both with wazuh-control info.
- No Alerts in Elastic - Trigger a test and check manager /var/ossec/logs/alerts/alerts.json.Check Vector logs for parsing errors.






