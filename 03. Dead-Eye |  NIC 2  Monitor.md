# Setup Guide - Proxmox PCI Passthrough NIC & Zeek
After initial installation it is recommended to get a snapshot if everything working as expected (Debian 13, ELK stack, Wazuh Manager). 
Poweroff the system and add the second NIC to Hardware in Proxmox settings.
## Add --> PCI device --> Choose Raw device and find and add your device for dropdown list.
---

## Verify PCI passthrough NIC is correct (CRITICAL)
Run  
```
ip addr
```  
You should see: eth0 (or similar) → has IP eth1 (or similar) → NO IP

Verify link state:  
```
ip link show eth1
```  
Bring it UP if is down (no IP):  
```
sudo ip link set eth1 up
```  

## Install Zeek
```
echo 'deb http://download.opensuse.org/repositories/security:/zeek/Debian_13/ /' | sudo tee /etc/apt/sources.list.d/security:zeek.list

curl -fsSL https://download.opensuse.org/repositories/security:zeek/Debian_13/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/security_zeek.gpg > /dev/null

sudo apt update && sudo apt install zeek
```  
**Check version - we want Zeek 7.x or later**  
```
/opt/zeek/bin/zeek --version
```  

## Add Zeek to PATH
```
echo 'export PATH=/opt/zeek/bin:$PATH' | sudo tee /etc/profile.d/zeek.sh
source /etc/profile.d/zeek.sh
```

- Now zeek --version and zeekctl work directly (log out/in or reboot for full effect)
- For sudo commands: Use full path sudo /opt/zeek/bin/zeekctl if PATH not inherited.

## Fix Permissions (For zeekctl/state.db)
```
sudo chown -R root:root /opt/zeek/spool /opt/zeek/logs
sudo chmod -R 755 /opt/zeek/spool /opt/zeek/logs
```

Disable before config  
```
sudo systemctl stop zeek
sudo systemctl disable zeek
```
## Edit Zeek configuration
Configs are in /opt/zeek/etc/ and site scripts in /opt/zeek/share/zeek/site/  
```
sudo vim /opt/zeek/etc/node.cfg

[zeek]
type=standalone
host=localhost
interface=eth1  # Replace with your PCI passthrough NIC name (e.g., eth1)
```  
## Networks Configuration
```
10.0.0.0/8      Private Networks
192.168.0.0/16  Private Networks
172.16.0.0/12   Private Networks
```

## Site-Specific Scripts (local.zeek)
```
sudo vim /opt/zeek/share/zeek/site/local.zeek

@load base/frameworks/notice
@load base/frameworks/logging
@load base/protocols/conn
@load base/protocols/http
@load base/protocols/dns
@load base/protocols/ssl
@load base/protocols/ssh
@load policy/frameworks/netcontrol/main
@load policy/misc/detect-traceroute

redef LogAscii::use_json = T;  # Enable JSON output (current standard)
```  

## Get Zeek scripts/policies
Zeek uses built-in and community scripts. For additional:  
Install Zeek community packages if needed:  
```
sudo apt install -y python3-git python3-semver
```  
Validate & Deploy Zeek:  
```
sudo /opt/zeek/bin/zeekctl check     # Validate configs
sudo /opt/zeek/bin/zeekctl install   # Apply changes
sudo /opt/zeek/bin/zeekctl deploy    # Start workers
sudo /opt/zeek/bin/zeekctl status    # Verify running
```  
## Create Systemd Service (Recommended for Auto-Start)
```
sudo vim /etc/systemd/system/zeek.service
[Unit]
Description=Zeek Network Security Monitor
After=network.target

[Service]
Type=forking
ExecStart=/opt/zeek/bin/zeekctl start
ExecStop=/opt/zeek/bin/zeekctl stop
ExecReload=/opt/zeek/bin/zeekctl restart
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

## Start Zeek in live mode
```
sudo systemctl daemon-reload
sudo systemctl enable zeek
sudo systemctl start zeek
sudo systemctl status zeek
```

Confirm it’s running:  
```
sudo systemctl status zeek --no-pager
```  
Validate configuration  
```
sudo zeek -i eth1 local "Site::local_nets += { 10.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12 }"  # Test run; replace eth1
```  
Check traffic on monitor NIC  
```
sudo tcpdump -i <NIC-2-Interface name> -c 30
```  

## Ingest data with Vector into Elasticsearch
Set permissions with acl so Vector can read Zeek logs - if zeek group exists just add vector user to zeek group 

Else - apt install acl and set the permissions
```
sudo setfacl -R -m u:vector:r /opt/zeek/logs/current
sudo setfacl -R -d -m u:vector:r /opt/zeek/logs/current
```  

## Create Vector pipeline
Append under wazuh in `/etc/vector/vector.yaml` (or a separate config file if using multiple):  
```
sources:
  wazuh_alerts:
    type: "file"
    include: ["/var/ossec/logs/alerts/alerts.json"]
    read_from: "beginning"
    data_dir: "/var/lib/vector"  # Shared – safe for distinct paths
    ignore_older_secs: 86400

  zeek_logs:
    type: "file"
    include: ["/opt/zeek/logs/current/*.log"]
    read_from: "beginning"
    data_dir: "/var/lib/vector"  # Shared
    ignore_older_secs: 86400

transforms:
  parse_wazuh:
    type: "remap"
    inputs: ["wazuh_alerts"]
    source: |
      . = parse_json!(.message)
      .@timestamp = parse_timestamp!(.timestamp, "%+")
      del(.message)

  parse_zeek:
    type: "remap"
    inputs: ["zeek_logs"]
    source: |
      . = parse_json!(.message)
      .@timestamp = from_unix_timestamp!(.ts)
      del(.message)

sinks:
  elasticsearch_wazuh:
    type: "elasticsearch"
    inputs: ["parse_wazuh"]
    endpoints: ["https://localhost:9200"]
    api_version: "auto"
    bulk:
      action: "index"
      index: "wazuh-alerts-%Y.%m.%d"
    batch:
      max_events: 1000
      timeout_secs: 30
    auth:
      strategy: "basic"
      user: "elastic"
      password: "${ELASTIC_PASSWORD}"
    tls:
      ca_file: "/etc/vector/elasticsearch-ca.crt"
      verify_certificate: true
      verify_hostname: true
    buffer:
      type: "disk"
      max_size: 1073741824
      when_full: "block"
    acknowledgements:
      enabled: true
    healthcheck:
      enabled: true
    request:
      timeout_secs: 60
      retries: 5

  elasticsearch_zeek:
    type: "elasticsearch"
    inputs: ["parse_zeek"]
    endpoints: ["https://localhost:9200"]
    api_version: "auto"
    bulk:
      action: "index"
      index: "zeek-events-%Y.%m.%d"
    batch:
      max_events: 1000
      timeout_secs: 30
    auth:
      strategy: "basic"
      user: "elastic"
      password: "${ELASTIC_PASSWORD}"
    tls:
      ca_file: "/etc/vector/elasticsearch-ca.crt"
      verify_certificate: true
      verify_hostname: true
    buffer:
      type: "disk"
      max_size: 1073741824
      when_full: "block"
    acknowledgements:
      enabled: true
    healthcheck:
      enabled: true
    request:
      timeout_secs: 60
      retries: 5
```

## Add Zeek data_dir
```
sudo mkdir -p /var/lib/vector
sudo chown -R vector:vector /var/lib/vector
```

## Restart Vector and watch for any errors
```
sudo systemctl restart vector
sudo journalctl -u vector -n 50 --no-pager
```  
Check if index exists  
```
sudo curl --cacert /etc/kibana/http_ca.crt -u elastic https://localhost:9200/_cat/indices/zeek-events-*?v
```  

## Create Kibana Data View for Zeek
Access Kibana  
Open your browser and go to https://YOUR_SERVER_IP:5601  
Log in with the elastic user and password  

## Navigate to Stack Management  
Step | Action
-----|-------
1 | Click the hamburger menu (☰)
2 | Go to Management → Stack Management
3 | Click Kibana → Data Views

1. Click "Create data view"
2. Configure the data view:
     
| Field | Value |
|-------|-------|
| Name | Zeek Events |
| Index pattern | zeek-events-* |
| Timestamp field | @timestamp |

3. Click "Save data view to Kibana"  

## Verify Data  
1. Go to Analytics → Discover  
2. Select your "Zeek Events" data view  
3. You should see Zeek logs appearing in real-time.  

## Then go to Discover and filter:  
1. event.module : zeek  
2. event.dataset : zeek.dns  
3. event.dataset : zeek.conn  
4. zeek.id : *
