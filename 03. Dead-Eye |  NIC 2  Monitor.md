# Setup Guide - Proxmox PCI Passthrough NIC & Zeek
After initial installation it is recommended to get a snapshot if everything working as expected (Debian 13, ELK stack, Wazuh Manager). 
Poweroff the system and add the second NIC to Hardware in Proxmox settings.
## Add --> PCI device --> Choose Raw device and find your device for dropdown list.
## Add the device and power on the system.

## Verify PCI passthrough NIC is correct (CRITICAL)
Run  
```
ip addr
```  
You should see: eth0 (or similar) → has IP eth1 (or similar) → NO IP

Verify link state:  
```
ip link show eth1
```  
Bring it UP if is down (no IP):  
```
sudo ip link set eth1 up
```  

## Install Zeek
```
sudo apt update
sudo apt install -y zeek
```  
**Check version - we want Zeek 7.x or later**  
```
zeek --version
```  
Disable before config  
```
sudo systemctl stop zeek
sudo systemctl disable zeek
```  

## Edit Zeek configuration
Configure as below - Tune up as per your requirements. Edit `/etc/zeek/node.cfg` to monitor the passthrough NIC:  
```
[zeek]
type=standalone
host=localhost
interface=eth1  # Replace with your PCI passthrough NIC name (e.g., eth1)
```  

For additional policies/scripts, enable in `/etc/zeek/zeekctl.cfg` or load via `@load` in `local.zeek`:  
Edit `/etc/zeek/site/local.zeek`:  
```
@load base/frameworks/notice
@load base/frameworks/logging
@load base/protocols/conn
@load base/protocols/http
@load base/protocols/dns
@load base/protocols/ssl
@load base/protocols/ssh
@load policy/frameworks/netcontrol/main
@load policy/misc/detect-traceroute

redef Log::default_writer = Log::WRITER_JSON;
redef Log::enable_log_rotation = F;  # Disable rotation if Vector tails directly
```  

## Get Zeek scripts/policies
Zeek uses built-in and community scripts. For additional:  
Install Zeek community packages if needed:  
```
sudo apt install -y python3-git python3-semver
sudo zeekctl install
```  
Update and deploy:  
```
sudo zeekctl deploy
```  

## Start Zeek in live mode
```
sudo systemctl enable zeek
sudo systemctl start zeek
```  
Confirm it’s running:  
```
sudo systemctl status zeek --no-pager
```  
Validate configuration  
```
sudo zeek -i eth1 local "Site::local_nets += { 10.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12 }"  # Test run; replace eth1
```  
Check traffic on monitor NIC  
```
sudo tcpdump -i <NIC-2-Interface name> -c 30
```  

## Ingest data with Vector into Elasticsearch
Set permissions with acl so Vector can read Zeek logs - if zeek group exists just add vector user to zeek group 

```
sudo setfacl -m u:vector:rX /var/log/zeek
sudo setfacl -m u:vector:r /var/log/zeek/*.log
sudo setfacl -d -m u:vector:rX /var/log/zeek
```  

## Create Vector pipeline
Append or create a new source/transform/sink in `/etc/vector/vector.yaml` (or a separate config file if using multiple):  
```
[sources.zeek_logs]
type = "file"
include = ["/var/log/zeek/*.log"]  # Tail all Zeek JSON logs (conn.log.json, dns.log.json, etc.)
read_from = "beginning"
data_dir = "/var/lib/vector/zeek"
ignore_older_secs = 86400

[transforms.parse_zeek]
type = "remap"
inputs = ["zeek_logs"]
source = '''
    . = parse_json!(.message) ?? {}
    if exists(.ts) {
        .["@timestamp"] = to_timestamp!(.ts) ?? now()
    }
    if is_null(.) { abort }
    .tags = ["source_zeek"]
'''

[sinks.elasticsearch_zeek]
type = "elasticsearch"
inputs = ["parse_zeek"]
endpoint = "https://localhost:9200"
index = "zeek-events-%{+YYYY.MM.dd}"
api_version = "v8"
bulk_action = "index"
batch.max_events = 1000
batch.timeout_secs = 30

auth.strategy = "basic"
auth.user = "elastic"
auth.password = "${ELASTIC_PASSWORD}"

tls.enabled = true
tls.ca_file = "/etc/vector/elasticsearch-ca.crt"
tls.verify_certificate = true

buffer.type = "disk"
buffer.max_size = 1073741824
buffer.when_full = "block"
```  

## Restart Vector and watch for any errors
```
sudo systemctl restart vector
sudo journalctl -u vector -n 50 --no-pager
```  
Check if index exists  
```
sudo curl --cacert /etc/kibana/http_ca.crt -u elastic https://localhost:9200/_cat/indices/zeek-events-*?v
```  

## Create Kibana Data View for Zeek
Access Kibana  
Open your browser and go to https://YOUR_SERVER_IP:5601  
Log in with the elastic user and password  

## Navigate to Stack Management  
| Step | Action |
|------|--------|
| 1    | Click the hamburger menu (☰) |
| 2    | Go to Management → Stack Management |
| 3    | Click Kibana → Data Views |

1. Click "Create data view"  
2. Configure the data view:  
| Field          | Value            |
|----------------|------------------|
| Name           | Zeek Events      |
| Index pattern  | zeek-events-*    |
| Timestamp field| @timestamp       |

3. Click "Save data view to Kibana"  

## Verify Data  
1. Go to Analytics → Discover  
2. Select your "Zeek Events" data view  
3. You should see Zeek logs appearing in real-time.  
## Then go to Discover and filter:  
1. event.module : zeek  
2. event.dataset : zeek.dns  
3. event.dataset : zeek.conn  
4. zeek.id : *
