# Setup Guide - Suricata & Zeek with Filebeat  
After initial installation it is recommended to get a snapshot if everything working as expected (Debian 13, ELK stack, Wazuh Manager).  
Poweroff the system and add the second NIC to Hardware in Proxmox settings.  
## Add --> PCI device --> Choose Raw device and find and add your device for dropdown list.
---

## Verify PCI passthrough NIC is correct (CRITICAL)
Run  
```
ip addr
```  
You should see: eth0 (or similar) → has IP eth1 (or similar) → NO IP

Verify link state:  
```
ip link show eth1
```  
Bring it UP if is down (no IP):  
```
sudo ip link set eth1 up
```  

## Install Zeek
```
echo 'deb http://download.opensuse.org/repositories/security:/zeek/Debian_13/ /' | sudo tee /etc/apt/sources.list.d/security:zeek.list
```
```
curl -fsSL https://download.opensuse.org/repositories/security:zeek/Debian_13/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/security_zeek.gpg > /dev/null
```
```
sudo apt update && sudo apt install zeek
```  
**Check version - we want Zeek 7.x or later**  
```
/opt/zeek/bin/zeek --version
```  

## Add Zeek to PATH
```
echo 'export PATH=/opt/zeek/bin:$PATH' | sudo tee /etc/profile.d/zeek.sh
```
```
source /etc/profile.d/zeek.sh
```

- Now zeek --version and zeekctl work directly (log out/in or reboot for full effect)
- For sudo commands: Use full path sudo /opt/zeek/bin/zeekctl if PATH not inherited.

## Fix Permissions (For zeekctl/state.db)
```
sudo chown -R root:root /opt/zeek/spool /opt/zeek/logs
```
```
sudo chmod -R 755 /opt/zeek/spool /opt/zeek/logs
```

Disable before config  
```
sudo systemctl stop zeek
```
```
sudo systemctl disable zeek
```
## Edit Zeek configuration
Configs are in /opt/zeek/etc/ and site scripts in /opt/zeek/share/zeek/site/  
```
sudo vim /opt/zeek/etc/node.cfg

[zeek]
type=standalone
host=localhost
interface=eth1  # Replace with your PCI passthrough NIC name (example: eth1)
```  

## Get Zeek scripts/policies
Zeek uses built-in and community scripts. For additional:  
Install Zeek community packages if needed:  
```
sudo apt install -y python3-git python3-semver
```  
Validate & Deploy Zeek:  
```
sudo /opt/zeek/bin/zeekctl check
```
```
sudo /opt/zeek/bin/zeekctl install
```
```
sudo /opt/zeek/bin/zeekctl deploy
```
```
sudo /opt/zeek/bin/zeekctl status
```  
## Create Systemd Service (Recommended for Auto-Start)
```
sudo vim /etc/systemd/system/zeek.service

[Unit]
Description=Zeek Network Security Monitor
After=network.target

[Service]
Type=forking
ExecStart=/opt/zeek/bin/zeekctl start
ExecStop=/opt/zeek/bin/zeekctl stop
ExecReload=/opt/zeek/bin/zeekctl restart
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

## Start Zeek in live mode
```
sudo systemctl daemon-reload
```
```
sudo systemctl enable zeek
```
```
sudo systemctl start zeek
```
```
sudo systemctl status zeek
```

Confirm it’s running:  
```
sudo systemctl status zeek --no-pager
```  
Validate configuration  
```
# Replace eth1 with your NIC 2 
sudo zeek -i eth1 local "Site::local_nets += { 10.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12 }"
```  
Check traffic on monitor NIC  
```
sudo tcpdump -i <NIC-2-Interface name> -c 30
```  

## Ingest data with Vector into Elasticsearch
Set permissions with acl so Vector can read Zeek logs  
If zeek group exists just add vector user to zeek group, else install acl and set the permissions
```
sudo apt instal acl
```
```
sudo setfacl -R -m u:vector:r /opt/zeek/logs/current
```
```
sudo setfacl -R -d -m u:vector:r /opt/zeek/logs/current
```  

## Create Vector pipeline
Append under wazuh in `/etc/vector/vector.yaml` (or a separate config file if using multiple):  
```
sources:
  wazuh_alerts:
    type: file
    include:
      - /var/ossec/logs/alerts/alerts.json
    read_from: end
    ignore_checkpoints: false

  zeek_logs:
    type: file
    include:
      - /opt/zeek/logs/current/*.log
    read_from: end

transforms:
  wazuh_parse:
    type: remap
    inputs: [wazuh_alerts]
    source: |
      # Parse JSON line
      .wazuh = parse_json!(.message)
      if !exists(.tags) || !is_array(.tags) { .tags = [] }
      .tags = push!(.tags, "source_wazuh")
      # timestamp -> @timestamp
      if exists(.wazuh.timestamp) {
        ."@timestamp" = parse_timestamp!(.wazuh.timestamp, "%+")
        del(.wazuh.timestamp)
      }
      # Force stable numeric types
      if exists(.wazuh.rule.level) { .wazuh.rule.level = to_int!(.wazuh.rule.level) }
      if exists(.wazuh.rule.firedtimes) { .wazuh.rule.firedtimes = to_int!(.wazuh.rule.firedtimes) }
      if exists(.wazuh.rule.frequency) { .wazuh.rule.frequency = to_int!(.wazuh.rule.frequency) }
      # ECS mapping
      if exists(.wazuh.agent.name) { .host.name = .wazuh.agent.name }
      if exists(.wazuh.agent.id) { .host.id = .wazuh.agent.id }
      # rule.id as string for stability
      if exists(.wazuh.rule.id) { .rule.id = to_string!(.wazuh.rule.id) }
      # rule.name from description
      if exists(.wazuh.rule.description) { .rule.name = .wazuh.rule.description }
      # event typing/severity
      if exists(.wazuh.rule.level) {
        .event.kind = "alert"
        .event.category = ["host"]
        .event.severity = .wazuh.rule.level
      }

  zeek_parse:
    type: remap
    inputs: ["zeek_logs"]
    source: |
      z = parse_json!(.message)
      .zeek = z
      .@timestamp = from_unix_timestamp(z.ts) ?? now()
      if exists(z.id.orig_h) { .source.ip = z.id.orig_h }
      if exists(z.id.resp_h) { .destination.ip = z.id.resp_h }
      if exists(z.id.orig_p) { .source.port = to_int!(z.id.orig_p) }
      if exists(z.id.resp_p) { .destination.port = to_int!(z.id.resp_p) }
      if exists(z.proto) { .network.transport = downcase!(z.proto) }
      .observer.product = "Zeek"
      .event.category = ["network"]
      if !exists(.tags) || !is_array(.tags) { .tags = [] }
      .tags = push!(.tags, "source_zeek")
      del(.message)

sinks:
  es_wazuh_alerts:
    type: elasticsearch
    inputs: [wazuh_parse]
    endpoints: ["https://localhost:9200"]
    auth:
      strategy: basic
      user: elastic
      password: ${ELASTIC_PASSWORD}
    tls:
      verify_certificate: true
      verify_hostname: true
      ca_file: /etc/vector/elasticsearch-ca.crt
    bulk:
      index: "wazuh-alerts-ecs-%Y.%m.%d"
    buffer:
      type: disk
      max_size: 5368709120
      when_full: block
    batch:
      max_bytes: 10000000
      timeout_secs: 1

  es_zeek:
    type: elasticsearch
    inputs: [zeek_parse]
    endpoints: ["https://localhost:9200"]
    auth:
      strategy: basic
      user: elastic
      password: ${ELASTIC_PASSWORD}
    tls:
      verify_certificate: true
      verify_hostname: true
      ca_file: /etc/vector/elasticsearch-ca.crt
    bulk:
      index: "zeek-ecs-%Y.%m.%d"
```

## Add Zeek data_dir
```
sudo mkdir -p /var/lib/vector
```
```
sudo chown -R vector:vector /var/lib/vector
```

## Restart Vector and watch for any errors
```
sudo systemctl restart vector
```
```
sudo journalctl -u vector -n 50 --no-pager
```  
Check if index exists  
```
sudo curl --cacert /etc/kibana/http_ca.crt -u elastic https://localhost:9200/_cat/indices/zeek-events-*?v
```  

## Create Kibana Data View for Zeek
Access Kibana  
Open your browser and go to https://YOUR_SERVER_IP:5601  
Log in with the elastic user and password  

## Navigate to Stack Management  
Step | Action
-----|-------
1 | Click the hamburger menu (☰)
2 | Go to Management → Stack Management
3 | Click Kibana → Data Views

1. Click "Create data view"
2. Configure the data view:
     
| Field | Value |
|-------|-------|
| Name | Zeek Events |
| Index pattern | zeek-ecs-* |
| Timestamp field | timestamp |

3. Click "Save data view to Kibana"  

## Verify Data  
1. Go to Analytics → Discover  
2. Select your "Zeek Events" data view  
3. You should see Zeek logs appearing in real-time.  

## Then go to Discover and filter:  
1. event.module : zeek  
2. event.dataset : zeek.dns  
3. event.dataset : zeek.conn  
4. zeek.id : *
