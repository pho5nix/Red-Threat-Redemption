# Setup Guide - Suricata & Zeek with Filebeat  
After initial installation it is recommended to get a snapshot if everything working as expected (Debian 13, Elastic, Vector, Wazuh Manager).  
Poweroff the system and add the second NIC to Hardware in Proxmox settings.  
## Add --> PCI device --> Choose Raw device and find and add your device for dropdown list.
---

## Verify PCI passthrough NIC is correct (CRITICAL)
Run  
```
ip addr
```  
You should see:  
eth0 (or similar) → has IP  
eth1 (or similar) → NO IP

Verify link state:  
```
ip link show eth1
```  
Bring it UP if is down (no IP):  
```
sudo ip link set eth1 up
```
## Optional - Add to interfaces
```
sudo vim /etc/network/interfaces

# Monitoring network interface
auto eth1
iface ens16 inet manual
```


## Install Filebeat
```
sudo apt update && sudo apt install filebeat
```

### Create keystore and add ingest_user to keystore
```
sudo filebeat keystore create
sudo filebeat keystore add ES_PASSWORD
```

## Zeek Installation & Configuration
```
echo 'deb http://download.opensuse.org/repositories/security:/zeek/Debian_13/ /' | sudo tee /etc/apt/sources.list.d/security:zeek.list

curl -fsSL https://download.opensuse.org/repositories/security:zeek/Debian_13/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/security_zeek.gpg > /dev/null
```
```
sudo apt update && sudo apt install zeek
```  
**Check version - we want Zeek 7.x or later**  
```
/opt/zeek/bin/zeek --version
```  

## Add Zeek to PATH
```
echo 'export PATH=/opt/zeek/bin:$PATH' | sudo tee /etc/profile.d/zeek.sh
```
```
source /etc/profile.d/zeek.sh
```

- Now zeek --version and zeekctl work directly (log out/in or reboot for full effect)
- For sudo commands: Use full path sudo /opt/zeek/bin/zeekctl if PATH not inherited.

## Fix Permissions (For zeekctl/state.db)
```
sudo chown -R root:root /opt/zeek/spool /opt/zeek/logs
```
```
sudo chmod -R 755 /opt/zeek/spool /opt/zeek/logs
```

Disable before config  
```
sudo systemctl stop zeek
```
```
sudo systemctl disable zeek
```
## Edit Zeek configuration
Configs are in /opt/zeek/etc/ and site scripts in /opt/zeek/share/zeek/site/  
```
sudo vim /opt/zeek/etc/node.cfg

[zeek]
type=standalone
host=localhost
interface=eth1  # Replace with your PCI passthrough NIC name (example: eth1)
```  

## Add policy for json logs - Elastic
```
sudo vim /opt/zeek/share/zeek/site/local.zeek

@load policy/tuning/json-logs
```

## Get Zeek scripts/policies
Zeek uses built-in and community scripts. For additional:  
Install Zeek community packages if needed:  
```
sudo apt install -y python3-git python3-semver
```

Validate & Deploy Zeek:  
Check
```
sudo /opt/zeek/bin/zeekctl check
```
Install
```
sudo /opt/zeek/bin/zeekctl install
```
Deploy
```
sudo /opt/zeek/bin/zeekctl deploy
```
Status
```
sudo /opt/zeek/bin/zeekctl status
```  
## Create Systemd Service (Recommended for Auto-Start)
```
sudo vim /etc/systemd/system/zeek.service

[Unit]
Description=Zeek Network Security Monitor
After=network.target

[Service]
Type=forking
ExecStart=/opt/zeek/bin/zeekctl start
ExecStop=/opt/zeek/bin/zeekctl stop
ExecReload=/opt/zeek/bin/zeekctl restart
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

## Start Zeek in live mode
Reload
```
sudo systemctl daemon-reload
```
Enable
```
sudo systemctl enable zeek
```
Start
```
sudo systemctl start zeek
```
Status
```
sudo systemctl status zeek
```

Confirm it’s running:  
```
sudo systemctl status zeek --no-pager
```  
Validate configuration  
```
# Replace eth1 with your NIC 2 
sudo zeek -i eth1 local "Site::local_nets += { 10.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12 }"
```  
Check traffic on monitor NIC  
```
sudo tcpdump -i <NIC-2-Interface name> -c 30
```  

## Suricata Installation & Configuration
```
sudo apt update && sudo apt install -y suricata
```
### Check version - We want Suricata 7.x or later, AF_PACKET support = YES
```
suricata --build-info | head -n 5
```
### Disable before configuration
```
sudo systemctl stop suricata
sudo systemctl disable suricata
```
### Configure Suricata - Adjust as below or use your own choices regarding your setup
```
sudo vim /etc/suricata/suricata.yaml

default-log-dir: /var/log/suricata/

stats:
  enabled: no

outputs:
  - fast:
      enabled: no
      filename: fast.log
      append: yes

  - eve-log:
      enabled: yes
      filetype: regular 
      filename: eve.json
   
    metadata: yes
    pcap-file: false

    community-id: true
   
    xff:
        enabled: no

    types:
     - alert:
       tagged-packets: no

     - frame:
        enabled: no

     - anomaly:
       enabled: yes

     - http:
       extended: no

     - dns:
       version: 2
       enabled: yes
       requests: yes
       responses: yes

     - tls:
       extended: no

     - files:
       force-magic: no

     - dhcp:
       enabled: yes
       extended: no

     - http-log:
       enabled: no
       filename: http.log
       append: yes

     - tls-log:
       enabled: no
       filename: tls.log
       append: yes

     - tls-store:
       enabled: no

# Linux high speed capture support - IMPORTANT: THIS IS WHERE YOU ASSIGHN THE NIC 2
af-packet:
  - interface: eht1
    cluster-id: 99
    cluster-type: cluster_flow
    defrag: yes
    use-mmap: yes
```
### Get IDS signatures (ET Open) using suricata-update
Update sources
```
sudo suricata-update update-sources
```
Enable ET Open
```
sudo suricata-update enable-source et/open
```
Download and build rules
```
sudo suricata-update
```
### Verify ET Open rules
```
sudo ls -lah /var/lib/suricata/rules/

sudo suricata -T -c /etc/suricata/suricata.yaml -i ens16
```

### Start Suricata
```
sudo systemctl enable suricata
sudo systemctl start suricata
```

## Create Kibana Data View for Zeek
Access Kibana  
Open your browser and go to https://YOUR_SERVER_IP:5601  
Log in with the elastic user and password  

## Navigate to Stack Management  
Step | Action
-----|-------
1 | Click the hamburger menu (☰)
2 | Go to Management → Stack Management
3 | Click Kibana → Data Views

1. Click "Create data view"
2. Configure the data view:
     
| Field | Value |
|-------|-------|
| Name | Zeek Events |
| Index pattern | zeek-ecs-* |
| Timestamp field | timestamp |

3. Click "Save data view to Kibana"  

## Verify Data  
1. Go to Analytics → Discover  
2. Select your "Zeek Events" data view  
3. You should see Zeek logs appearing in real-time.  

## Then go to Discover and filter:  
1. event.module : zeek  
2. event.dataset : zeek.dns  
3. event.dataset : zeek.conn  
4. zeek.id : *
