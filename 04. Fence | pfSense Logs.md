# pfSense Logs Integration (Syslog and Suricata EVE JSON)
---
## Configure pfSense Logs Forwarding
### System Logs (Built-in Syslog)
In pfSense UI:  
- Go to **Status > System Logs > Settings**.  
- Under **Remote Logging**, enable **Send log messages to remote syslog server**.  
- Add remote server: `YOUR_DEBIAN_IP:5514` (UDP, default facility/levels are fine; use RFC5424 for better timestamps).  
- Select categories to forward (e.g., Firewall, System, DHCP).  
- Save and Apply.  

### Suricata Logs (via Syslog-ng Package)
Install syslog-ng package in pfSense:  
- Go to **System > Package Manager > Available Packages**.  
- Search for and install **syslog-ng**.  

Configure syslog-ng for Suricata EVE JSON:  
- Go to **Services > Syslog-ng > Advanced**.  
- Add a source:
  1. Object Name: s_suricata
  2. Object Type: Source
  3. Objject Parameters:
     ```
     {
       wildcard-file(
         base-dir("/var/log/suricata/")
         filename-pattern("eve.json")
         recursive(yes)
         flags(no-parse)
       );
     };
     ```
- Add a destination:
  1. Object Name: d_vector
  2. Object Type: Destination
  3. Object Parameters:
     ```
     {
          tcp("YOUR-DEBIAN-IP" port(6000));
     };
     ```
- Add a log path:
  1. Object Name: log_suricata
  2. Object Type: Log
  3. Object Parameters:
     ```
     { source(s_suricata); destination(d_vector); };
     ```  
- Enable JSON forwarding.  
- Apply changes.  


## Configure Vector for pfSense Logs
Vector will receive: standard pfSense system logs on 5514 (UDP) and Suricata EVE JSON on 514 (UDP). No additional installation needed (Vector already installed).

## Create Vector Pipeline
Append or create new sources/transforms/sinks in `/etc/vector/vector.yaml`:  
```
[sources.pfsense_syslog]
type = "syslog"
address = "0.0.0.0:5514"  # Listen for pfSense system logs
mode = "udp"
max_message_size = "64KiB"

[sources.pfsense_suricata]
type = "syslog"
address = "0.0.0.0:6000"  # Listen for Suricata EVE via syslog-ng
mode = "udp"
max_message_size = "64KiB"

[transforms.parse_pfsense_syslog]
type = "remap"
inputs = ["pfsense_syslog"]
source = '''
    . = parse_syslog!(.message) ?? {}  # Parse standard syslog
    .tags = ["pfsense_syslog"]
    if exists(.timestamp) {
        .["@timestamp"] = to_timestamp!(.timestamp) ?? now()
    }
    if is_null(.) { abort }
'''

[transforms.parse_pfsense_suricata]
type = "remap"
inputs = ["pfsense_suricata"]
source = '''
    . = parse_syslog!(.message) ?? {}  # Attempt syslog parse
    if starts_with(.message, "{") {    # Extract and parse EVE JSON payload
        . = parse_json!(.message) ?? {}
    }
    .tags = ["pfsense_suricata"]
    if exists(.timestamp) {
        .["@timestamp"] = to_timestamp!(.timestamp) ?? now()
    }
    if is_null(.) { abort }
'''

[sinks.elasticsearch_pfsense_syslog]
type = "elasticsearch"
inputs = ["parse_pfsense_syslog"]
endpoint = "https://localhost:9200"
index = "pfsense-logs-%{+YYYY.MM.dd}"
api_version = "v8"
bulk_action = "index"
batch.max_events = 1000
batch.timeout_secs = 30

auth.strategy = "basic"
auth.user = "elastic"
auth.password = "${ELASTIC_PASSWORD}"

tls.enabled = true
tls.ca_file = "/etc/vector/elasticsearch-ca.crt"
tls.verify_certificate = true

buffer.type = "disk"
buffer.max_size = 1073741824  # 1GB
buffer.when_full = "block"

[sinks.elasticsearch_pfsense_suricata]
type = "elasticsearch"
inputs = ["parse_pfsense_suricata"]
endpoint = "https://localhost:9200"
index = "pfsense-suricata-%{+YYYY.MM.dd}"
api_version = "v8"
bulk_action = "index"
batch.max_events = 1000
batch.timeout_secs = 30

auth.strategy = "basic"
auth.user = "elastic"
auth.password = "${ELASTIC_PASSWORD}"

tls.enabled = true
tls.ca_file = "/etc/vector/elasticsearch-ca.crt"
tls.verify_certificate = true

buffer.type = "disk"
buffer.max_size = 1073741824  # 1GB
buffer.when_full = "block"
```

## Restart Vector and Watch for Errors
```
sudo systemctl restart vector
sudo journalctl -u vector -n 50 --no-pager
```  
Look for successful reception and parsing (no parse errors).

## Check if Indices Exist
```
sudo curl --cacert /etc/kibana/http_ca.crt -u elastic https://localhost:9200/_cat/indices/pfsense-logs-*?v
sudo curl --cacert /etc/kibana/http_ca.crt -u elastic https://localhost:9200/_cat/indices/pfsense-suricata-*?v
```

## Create Kibana Data Views for pfSense
Access Kibana  
Open your browser and go to https://YOUR_SERVER_IP:5601  
Log in with the elastic user and password  

## Navigate to Stack Management  
Step | Action
|----|--------|
 1 | Click the hamburger menu (☰)
 2 | Go to Management → Stack Management
 3 | Click Kibana → Data Views

## Create pfSense syslog Data View
1. Click "Create data view"  
2. Configure the data view:  

Name: pfSense Logs  
Index pattern: pfsense-logs-*  
Timestamp field: @timestamp  

3. Click "Save data view to Kibana"  

## Create pfSense Suricata Data View  
1. Click "Create data view"  
2. Configure the data view:  

Name: pfSense Suricata Events  
Index pattern: pfsense-suricata-*  
Timestamp field: @timestamp  

3. Click "Save data view to Kibana"  

## Verify Data
Go to Analytics → Discover  
Select your "pfSense Logs" data view  
You should see system logs appearing in real-time. Filter examples:  
host.hostname : "your_pfsense_host"  
message : "filterlog"  # For firewall logs  

Select your "pfSense Suricata Events" data view  
You should see Suricata EVE events. Filter examples:  
event_type : "alert"  
event_type : "dns"  
community_id : *  
