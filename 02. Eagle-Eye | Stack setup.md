# Setup Guide - SIEM Stack
Complete setup guide for integrating Elasticsearch, Kibana, Vector with Wazuh Manager on Debian 13

## System Requirements & Configuration
### System Specifications
| Component | Requirement |
|-----------|-------------|
| Operating System | Debian 13 |
| RAM | 32GB |
| CPU | 8 cores |
| Storage | 220GB SSD |
| Network | 2 NICs (Management + PCI passthrough) |
| Hypervisor | Proxmox VE |

### NIC Layout
| NIC | Purpose |
|-----|---------|
| NIC 1 | Management (Elastic, Syslog, UI) |
| NIC 2 | PCI Passthrough - Monitoring (Zeek) |

NIC 2 must **NOT** be configured with an IP address or managed by NetworkManager

### Before You Begin
* Ensure you have root or sudo access
* IOMMU enabled in Proxmox
* Verify system meets minimum requirements
* Debian installed with only NIC 1 configured

## Installation Overview
This guide covers the following components in order:

1. Elasticsearch - Search and analytics engine
2. Kibana - Data visualization platform
3. Vector - Data processing pipeline
4. Wazuh Manager - Security monitoring platform
5. Integration Configuration - Connect all components

## Part 1: Elasticsearch Installation
### Step 1.1: Import Elasticsearch PGP Key
```
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg
```

### Step 1.2: Set Up Repository
First, install the required transport package:
```
sudo apt-get install apt-transport-https
```

Add the Elasticsearch repository:
```
echo "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/9.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-9.x.list
```

### Step 1.3: Install Elasticsearch
```
sudo apt-get update && sudo apt-get install elasticsearch
```

## Part 2: System Configuration for Elasticsearch
### Step 2.1: Configure Service Limits
Create systemd override configuration:
```
sudo systemctl edit elasticsearch
```

Add the following content:
```
[Service]
LimitMEMLOCK=infinity
```

Reload systemd daemon:
```
sudo systemctl daemon-reload
```

### Step 2.2: Disable Swap
Important: Elasticsearch performance degrades significantly with swap enabled.
```
# Disable current swap
sudo swapoff -a

# Make permanent by commenting swap in fstab
sudo sed -i '/ swap / s/^/#/' /etc/fstab
```

### Step 2.3: Memory and Network Optimizations
Configure virtual memory limits:
```
sudo vim /etc/sysctl.d/99-elastic.conf
vm.max_map_count=262144

sudo sysctl --system
```

File-descriptor limits (critical for Elastic)
```
sudo vim /etc/security/limits.conf
* soft nofile 65536
* hard nofile 65536
```

### Step 2.4: Configure JVM Heap Size
Tip: Set heap size to 50% of available RAM, maximum 31GB
```
sudo vim /etc/elasticsearch/jvm.options.d/heap.options
# Heap size - configured for 32GB RAM system
-Xms16g
-Xmx16g
```

## Part 3: Elasticsearch Configuration
### Step 3.1: Backup Original Configuration
```
sudo cp /etc/elasticsearch/elasticsearch.yml /etc/elasticsearch/elasticsearch.yml.default
```

### Step 3.2: Configure Elasticsearch
Edit the main configuration file:
```
sudo vim /etc/elasticsearch/elasticsearch.yml
```

Replace the entire file content with:
```
# ======================== Elasticsearch Configuration =========================

cluster.name: wazuh-elastic-cluster
node.name: es-node-1

path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

bootstrap.memory_lock: true

network.host: "localhost"
http.port: 9200

discovery.type: single-node

#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------

# Enable security features
xpack.security.enabled: true
xpack.security.enrollment.enabled: true

# Enable encryption for HTTP API client connections
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12

#----------------------- END SECURITY AUTO CONFIGURATION -------------------------
```

### Step 3.3: Start Elasticsearch
```
sudo systemctl enable elasticsearch
sudo systemctl start elasticsearch
```

### Step 3.4: Secure Elasticsearch & Generate Password
```
/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
```

Important: Save the generated password securely - we will add it later to keystore for using it in vector.yaml

### Step 3.5: Verify Installation
Test Elasticsearch is running:
```
sudo curl --cacert /etc/elasticsearch/certs/http_ca.crt --resolve localhost:9200:127.0.0.1 -u elastic https://localhost:9200
```

Expected output:
```
{
  "name" : "es-node-1",
  "cluster_name" : "wazuh-elastic-cluster",
  "cluster_uuid" : "fefgsevSGVBSDBasdfgasdGGR",
  "version" : {
    "number" : "9.3.0",
    "build_flavor" : "default",
    "build_type" : "deb"
  },
  "tagline" : "You Know, for Search"
}
```

Checkpoint: Elasticsearch should now be running and secured

## Part 4: Kibana Installation
### Step 4.1: Install Kibana
```
sudo apt install kibana -y
```

### Step 4.2: Copy SSL Certificate
```
sudo cp /etc/elasticsearch/certs/http_ca.crt /etc/kibana/http_ca.crt
sudo chown kibana:kibana /etc/kibana/http_ca.crt
sudo chmod 644 /etc/kibana/http_ca.crt
```

### Step 4.3: Configure Kibana
Edit Kibana configuration:
```
sudo vim /etc/kibana/kibana.yml
```

Add these configurations:
```
server.host: "0.0.0.0"
server.port: 5601
server.publicBaseUrl: "https://YOUR-SERVER-IP:5601"

server.ssl.enabled: true
server.ssl.certificate: /etc/kibana/certs/kibana-server/kibana-server.crt
server.ssl.key: /etc/kibana/certs/kibana-server/kibana-server.key

elasticsearch.hosts: ["https://localhost:9200"]
elasticsearch.ssl.certificateAuthorities: ["/etc/kibana/http_ca.crt"]
elasticsearch.username: "kibana_system"
```

### Step 4.4: Enable HTTPS on Kibana
self-signed Kibana cert
```
sudo mkdir -p /etc/kibana/certs
sudo /usr/share/elasticsearch/bin/elasticsearch-certutil cert --self-signed --name kibana-server --dns YOUR-SERVER-HOSTNAME --pem --out /etc/kibana/certs/kibana.zip
unzip /etc/kibana/certs/kibana.zip -d /etc/kibana/certs
sudo chown -R kibana:kibana /etc/kibana/certs
sudo chmod 600 /etc/kibana/certs/kibana-server/kibana-server.key
sudo chmod 644 /etc/kibana/certs/kibana-server/kibana-server.crt
```

Note: Generate password for kibana_system and store in Kibana keystore
```
sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u kibana_system
```

Copy the generated password.
```
sudo /usr/share/kibana/bin/kibana-keystore create
sudo /usr/share/kibana/bin/kibana-keystore add elasticsearch.password
```

When prompted, paste the kibana_system password you generated.

### Step 4.5: Start Kibana
```
sudo systemctl enable kibana
sudo systemctl start kibana
```

### Step 4.6: Access Kibana
Open your browser and navigate to: https://YOUR_SERVER_IP:5601  
Use the elastic user and password to login, not the kibana_system  

Checkpoint: Kibana should be accessible and connected to Elasticsearch

## Part 5: Vector Installation
### Step 5.1: Install Vector
```
curl -1sLf 'https://repositories.timber.io/public/vector/cfg/setup/bash.deb.sh' | sudo -E bash
sudo apt update && sudo apt install vector -y
```

### Step 5.2: Copy SSL Certificate
```
sudo cp /etc/elasticsearch/certs/http_ca.crt /etc/vector/elasticsearch-ca.crt
sudo chown vector:vector /etc/vector/elasticsearch-ca.crt
sudo chmod 644 /etc/vector/elasticsearch-ca.crt
```

## Part 6: Wazuh Manager Installation
### Step 6.1: Add Wazuh Repository
Import the Wazuh GPG key:
```
curl -fsSL https://packages.wazuh.com/key/GPG-KEY-WAZUH | gpg --dearmor | sudo tee /usr/share/keyrings/wazuh.gpg >/dev/null
```

Add the repository:
```
echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" | sudo tee /etc/apt/sources.list.d/wazuh.list
```

### Step 6.2: Install Wazuh Manager
```
sudo apt-get update
sudo apt-get install wazuh-manager
```

### Step 6.3: Start Wazuh Manager
```
sudo systemctl daemon-reload
sudo systemctl enable wazuh-manager
sudo systemctl start wazuh-manager
```

### Step 6.4: Verify Wazuh Installation
```
sudo systemctl status wazuh-manager
```

Checkpoint: Wazuh Manager should be running and active

## Part 7: Integration Configuration
### Step 7.1: Configure Permissions
Permissions for Vector:
```
sudo usermod -aG ossec vector
sudo chmod 750 /var/ossec/logs/alerts
sudo chmod 640 /var/ossec/logs/alerts/alerts.json
```

### Step 7.2: Create Vector Pipeline
Create the Wazuh pipeline configuration (enhanced with batching for efficiency and error handling):
```
sudo nano /etc/vector/vector.yaml
[sources.wazuh_alerts]
type = "file"
include = ["/var/ossec/logs/alerts/alerts.json"]
read_from = "beginning"
data_dir = "/var/lib/vector"
ignore_older_secs = 86400  # Ignore files older than 1 day for efficiency

# Parse the JSON lines
[transforms.parse_wazuh]
type = "remap"
inputs = ["wazuh_alerts"]
source = '''
    . = parse_json!(.message) ?? {}
    # Ensure @timestamp is set for Kibana
    if exists(.timestamp) {
        .["@timestamp"] = to_timestamp!(.timestamp) ?? now()
    }
    # Error handling: Drop invalid events
    if is_null(.) { abort }
'''

# Send to Elasticsearch with batching
[sinks.elasticsearch]
type = "elasticsearch"
inputs = ["parse_wazuh"]
endpoint = "https://localhost:9200"
index = "wazuh-alerts-%{+YYYY.MM.dd}"
api_version = "v8"
bulk_action = "index"
batch.max_events = 1000  # Batch for efficiency
batch.timeout_secs = 30

# Authentication & TLS
auth.strategy = "basic"
auth.user = "elastic"
auth.password = "\${ELASTIC_PASSWORD}"

tls.enabled = true
tls.ca_file = "/etc/vector/elasticsearch-ca.crt"
tls.verify_certificate = true

# Buffer for resilience (disk-based if memory overflows)
buffer.type = "disk"
buffer.max_size = 1073741824  # 1GB max buffer
buffer.when_full = "block"
```

### Step 7.3: Secure the Elastic Password
Vector supports environment variable interpolation in its configuration files. To avoid storing the password in plain text:

Create a systemd override for the Vector service to set the environment variable:
```
sudo systemctl edit vector
```

Add the following content (replace `your_generated_password` with the actual password from Step 3.4):
```
[Service]
Environment="ELASTIC_PASSWORD=your_generated_password"
```

Reload systemd and restart Vector:
```
sudo systemctl daemon-reload
sudo systemctl restart vector
```

This stores the password in a protected systemd override file (/etc/systemd/system/vector.service.d/override.conf) instead of the main config.

### Step 7.4: Verify Pipeline
Check Vector logs for any errors:
```
sudo journalctl -u vector -f
```

Checkpoint: Vector should be processing Wazuh alerts and sending to Elasticsearch

## Part 8: Create Kibana Data View for wazuh-alerts-*
### Step 8.1: Access Kibana
1. Open your browser and go to https://YOUR_SERVER_IP:5601
2. Log in with the elastic user and password

### Step 8.2: Navigate to Stack Management
Step | Action
-----|-------
1 | Click the hamburger menu (☰)
2 | Go to Management → Stack Management
3 | Click Kibana → Data Views

### Step 8.3: Create Wazuh Data View
1. Click "Create data view"
2. Configure the data view:

| Field | Value |
|-------|-------|
| Name | Wazuh Alerts |
| Index pattern | wazuh-alerts-* |
| Timestamp field | @timestamp |

3. Click "Save data view to Kibana"

### Step 8.4: Verify Data
1. Go to Analytics → Discover
2. Select your "Wazuh Alerts" data view
3. You should see Wazuh alerts appearing in real-time.

## Verification Checklist
Before considering the installation complete, verify all components:

| Component | Status | Verification Command |
|-----------|--------|----------------------|
| Elasticsearch | Running | curl -k -u elastic:PASSWORD https://localhost:9200 |
| Kibana | Accessible | Browse to https://YOUR_IP:5601 |
| Vector | Processing | sudo journalctl -u vector --since "5 minutes ago" |
| Wazuh Manager | Active | sudo systemctl status wazuh-manager |
| Data Flow | Working | Check Kibana Discover for wazuh-alerts-* indices |

## Troubleshooting
### Common Issues & Solutions
| Issue | Possible Cause | Solution |
|-------|----------------|----------|
| Elasticsearch won't start | Insufficient memory/swap enabled | Check heap size, disable swap |
| Kibana connection fails | SSL certificate issues | Verify http_ca.crt is copied correctly |
| No data in Kibana | Vector pipeline errors | Check journalctl -u vector |
| Permission denied errors | Incorrect file ownership | Verify user permissions with ls -la |

## Log Locations
| Service | Log Location |
|---------|--------------|
| Elasticsearch | /var/log/elasticsearch/ |
| Kibana | /var/log/kibana/ |
| Vector | journalctl -u vector |
| Wazuh | /var/ossec/logs/ |

## Additional Resources
* Elasticsearch Official Documentation
* Wazuh Documentation
* Kibana User Guide
* Vector Documentation
