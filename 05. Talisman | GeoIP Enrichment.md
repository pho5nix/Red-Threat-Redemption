# Add GeoIP Enrichment to Vector Components
---

## We need to Signup at **maxmind.com** and download GeoLite2-City.mmdb
- Sign up at https://www.maxmind.com and generate license key.

## On Debian:
Download tarball
```
cd /tmp
wget "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=YOUR_LICENSE_KEY&suffix=tar.gz" -O GeoLite2-City.tar.gz
```
Extract and copy mmdb to vector directory
```
tar -xzf GeoLite2-City.tar.gz
cp GeoLite2-City_*/GeoLite2-City.mmdb /etc/vector/GeoLite2-City.mmdb
```
Assign Permissions
```
chown root:vector /etc/vector/GeoLite2-City.mmdb
chmod 644 /etc/vector/GeoLite2-City.mmdb
```

**Optional weekly update:**  
- Install geoipupdate, configure /etc/GeoIP.conf with AccountID/LicenseKey/EditionIDs, run geoipupdate.
- Add cron: 0 3 * * 0 /usr/bin/geoipupdate.
---

- For airgaped infrastructure download and update mmdb file manually at your scheduled updates.
---

## Update vector.yaml
- Add on top (under data_dir: /var/lib/vector)
```
enrichment_tables:
  geoip_city:
    type: geoip
    path: "/etc/vector/GeoLite2-City.mmdb"
```  

**pfSense Enrichment**
- Add in transforms after pfsense_filterlog:
```
  pfsense_geoip_src:
    type: remap
    inputs: ["pfsense_filterlog"]
    source: |
      geo, err = get_enrichment_table_record("geoip_city", { "ip": .source.ip })
      if err == null { .source.geo = geo } else { .source.geo = {} }

  pfsense_geoip_dest:
    type: remap
    inputs: ["pfsense_geoip_src"]
    source: |
      geo, err = get_enrichment_table_record("geoip_city", { "ip": .destination.ip })
      if err == null { .destination.geo = geo } else { .destination.geo = {} }

  pfsense_geo_point:
    type: remap
    inputs: ["pfsense_geoip_dest"]
    source: |
      if exists(.source.geo.latitude) && exists(.source.geo.longitude) {
        lat = to_float!(.source.geo.latitude)
        lon = to_float!(.source.geo.longitude)
        .source.geo.location = { "lat": lat, "lon": lon }
      }
      if exists(.destination.geo.latitude) && exists(.destination.geo.longitude) {
        lat = to_float!(.destination.geo.latitude)
        lon = to_float!(.destination.geo.longitude)
        .destination.geo.location = { "lat": lat, "lon": lon }
      }
```

**Update es_pfsense inputs in sinks with ["pfsense_geo_point"]**
```
es_pfsense:
    type: elasticsearch
    inputs: ["pfsense_geo_point"]
```

**Wazuh Enrichment**
- Add in transforms after wazuh_parse:
```
wazuh_geoip_src:
  type: remap
  inputs: ["wazuh_parse"]
  source: |
    geo, err = get_enrichment_table_record("geoip_city", { "ip": .source.ip })
    if err == null { .source.geo = geo } else { .source.geo = {} }

wazuh_geoip_dest:
  type: remap
  inputs: ["wazuh_geoip_src"]
  source: |
    geo, err = get_enrichment_table_record("geoip_city", { "ip": .destination.ip })
    if err == null { .destination.geo = geo } else { .destination.geo = {} }

wazuh_geo_point:
  type: remap
  inputs: ["wazuh_geoip_dest"]
  source: |
    if exists(.source.geo.latitude) && exists(.source.geo.longitude) {
      lat = to_float!(.source.geo.latitude)
      lon = to_float!(.source.geo.longitude)
      .source.geo.location = { "lat": lat, "lon": lon }
    }
    if exists(.destination.geo.latitude) && exists(.destination.geo.longitude) {
      lat = to_float!(.destination.geo.latitude)
      lon = to_float!(.destination.geo.longitude)
      .destination.geo.location = { "lat": lat, "lon": lon }
    }
```

**Update es_wazuh_alerts inputs in sinks with ["wazuh_geo_point"]**
```
es_wazuh-alerts:
    type: elasticsearch
    inputs: ["wazuh_geo_point"]
```

**pfBlocker Enrichment**
- Add in transforms after pfblocker_parse:
```
  pfblocker_geoip_src:
    type: remap
    inputs: ["pfblocker_parse"]
    source: |
      if exists(.source.ip) {
        geo, err = get_enrichment_table_record("geoip_city", { "ip": .source.ip })
        if err == null { .source.geo = geo } else { .source.geo = {} }
      }

  pfblocker_geoip_dest:
    type: remap
    inputs: ["pfblocker_geoip_src"]
    source: |
      if exists(.destination.ip) {
        geo, err = get_enrichment_table_record("geoip_city", { "ip": .destination.ip })
        if err == null { .destination.geo = geo } else { .destination.geo = {} }
      }

  pfblocker_geo_point:
    type: remap
    inputs: ["pfblocker_geoip_dest"]
    source: |
      if exists(.source.geo.latitude) && exists(.source.geo.longitude) {
        .source.geo.location = { "lat": to_float!(.source.geo.latitude), "lon": to_float!(.source.geo.longitude) }
      }
      if exists(.destination.geo.latitude) && exists(.destination.geo.longitude) {
        .destination.geo.location = { "lat": to_float!(.destination.geo.latitude), "lon": to_float!(.destination.geo.longitude) }
      }

  pfblocker_tagged:
    type: remap
    inputs: ["pfblocker_geo_point"]
    source: |
      if !exists(.tags) || !is_array(.tags) { .tags = [] }
      .tags = push!(.tags, "source_pfblockerng")
```
**Update es_pfblocker inputs in sinks with ["pfblocker_geo_point"]**
```
 es_pfblocker:
    type: elasticsearch
    inputs: ["pfblocker_tagged"]
```

## Add Elasticsearch Index Templates
**Navigate to Dev Tools - Kibana**
Step | Action
-----|-------
1 | Click the hamburger menu (☰)
2 | Go to Management → Dev Tools

## Make 4 POST requests to create the template for each component.  
- Replace INDEX with pfsense-ecs, wazuh-alerts-ecs, pfblocker-ecs for each request:

```
PUT _index_template/INDEX-template
{
  "index_patterns": ["INDEX-*"],
  "template": {
    "mappings": {
      "properties": {
        "source": {
          "properties": {
            "geo": {
              "properties": {
                "location": { "type": "geo_point" }
              }
            }
          }
        },
        "destination": {
          "properties": {
            "geo": {
              "properties": {
                "location": { "type": "geo_point" }
              }
            }
          }
        }
      }
    }
  }
}
```

## Final Steps
- Delete old indices
  1. Find indices by GET request at Dev tools - GET /_cat/indices
  2. Delete indice with DELETE request - DELETE /INDEX-YYYY.MM.DD - examople: DELETE zeek-ecs-1881.07.21
- Restart Vector
- Monitor Vector logs for any errors: sudo journalctl -u vector -f
- -Trigger events with public IPs.




