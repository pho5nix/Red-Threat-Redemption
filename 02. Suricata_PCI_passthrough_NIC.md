# Add Suricata (PCI Passthrough NIC)

---
After initial installation it is recommended to get a snapshot if everything working as expected (Debian 13, ELK stack, Wazuh Manager).
---

Poweroff the system and add the second NIC to Hardware in Proxmox settings.
Add --> PCI device --> Choose Raw device and find your device for dropdown list
Add the device and power on the system

## Verify PCI passthrough NIC is correct (CRITICAL)

**Run**
```bash
ip addr
```

**You should see:**
eth0 (or similar) → has IP
eth1 (or similar) → NO IP

Verify link state:
```
ip link show eth1
```

Bring it UP if is down (no IP):
```
sudo ip link set eth1 up
```

# Install Suricata
```bash
sudo apt update
sudo apt install -y suricata
```

**Check version - we want Suricata 7.x or later and AF_PACKET support
```
suricata --build-info | head -n 5
```

## Disable before config
```bash
sudo systemctl stop suricata
sudo systemctl disable suricata
```

## Edit suricata.yml
---
**Configure as below - Tune up as per your requirements**

```yaml
vars:
  address-groups:
    HOME_NET: "[10.0.0.0/8,192.168.0.0/16,172.16.0.0/12]"
    EXTERNAL_NET: "!$HOME_NET"

outputs:
  - eve-log:
      enabled: yes
      filetype: regular
      filename: eve.json
      community-id: true
      # Suricata will flush periodically; defaults are ok, but you can set:
      # flush: yes
      # interval: 5

      types:
        - alert:
            tagged-packets: no
        - http
        - dns
        - tls
        - ssh
        - flow
        - netflow
        - stats:
            totals: yes
            threads: no
        - anomaly
            enabled: yes

af-packet:
  - interface: <MIRROR_NIC_NAME>
    cluster-type: cluster_flow
    cluster-id: 99
    threads: 4
    defrag: yes
    use-mmap: yes
    # Keep memory reasonable (ring-size is per thread)
    ring-size: 2048
    # optional: leave off unless you’re chasing packet drops
    # block-size: 65535

runmode: workers

```

## Get IDS signatures (ET Open) using suricata-update
**Right now you only have the “events” rules. For actual detections, do:**

a) Update sources index
```bash
sudo suricata-update update-sources

# Check sources
sudo suricata-update list-sources
```

b) Enable ET Open (free, standard)
```
sudo suricata-update enable-source et/open
```

Recommended:
```
suricata-update enable-source et/open
suricata-update enable-source abuse.ch/sslbl-blacklist
suricata-update enable-source abuse.ch/urlhaus
suricata-update enable-source abuse.ch/feodotracker
```

c) Download and build rules
```
sudo suricata-update
```
**This produces a combined rules file in /var/lib/suricata/rules/ (often suricata.rules).**

## Start Suricata in live mode

```
sudo systemctl enable suricata
sudo systemctl start suricata
```

**Confirm it’s running:**

```
sudo systemctl status suricata --no-pager
```

## Validate configuration file
```
sudo suricata -T -c /etc/suricata/suricata.yaml -i <NIC-2 Interface name>
```

## Check traffic on monitor NIC
```
sudo tcpdump -i <NIC-2-Interface name> -c 30
```

# Ingest data with Logstash into Elasticsearch

## Set permissions with acl so Logstash can read EVE - if suricata group exists just add logstash user to suricata group
```
sudo setfacl -m u:logstash:rX /var/log/suricata
sudo setfacl -m u:logstash:r /var/log/suricata/eve.json
sudo setfacl -d -m u:logstash:rX /var/log/suricata
```

# Create Logstash pipeline
```
sudo nano /etc/logstash/conf.d/suricata.conf
```

**Configuration**
```
input {
  file {
    path => "/var/log/suricata/eve.json"
    mode => "tail"
    start_position => "end"
    sincedb_path => "/var/lib/logstash/suricata.sincedb"
    stat_interval => 1

    codec => json {
      target => "suricata"
      ecs_compatibility => "disabled"
    }

    type => "suricata"
  }
}

filter {
  if [type] == "suricata" {

    # Suricata EVE uses "timestamp" at top of its JSON object.
    if [suricata][timestamp] {
      date {
        match => ["[suricata][timestamp]", "ISO8601"]
        target => "@timestamp"
        remove_field => ["[suricata][timestamp]"]
      }
    }

    # Optional: add a lightweight tag for easier filtering
    mutate {
      add_tag => ["source_suricata"]
    }

    # Optional: drop super-noisy event types if you ever re-enable them
    # if [suricata][event_type] == "stats" { drop {} }
  }
}

output {
  if [type] == "suricata" {
    elasticsearch {
      hosts => ["https://localhost:9200"]
      index => "suricata-events-%{+YYYY.MM.dd}"

      user => "elastic"
      password => "YOUR_ELASTIC_PASSWORD"

      ssl_enabled => true
      ssl_certificate_authorities => ["/etc/logstash/http_ca.crt"]
      ssl_verification_mode => "full"
    }
  }
}

```

## Restart Logstash and watch for any errors
```
sudo systemctl restart logstash
sudo journalctl -u logstash -n 50 --no-pager
```

## Check if index exists
```
sudo curl --cacert /etc/kibana/http_ca.crt -u elastic https://localhost:9200/_cat/indices/suricata-events-*?v
```

## Create Kibana Data View for Suricata

In Kibana:

Stack Management → Data Views → Create data view

- Name: Suricata Events

- Index pattern: suricata-events-*

- Time field: @timestamp

Then go to Discover and filter:

- suricata.event_type : alert

- suricata.event_type : dns

- suricata.community_id : *
