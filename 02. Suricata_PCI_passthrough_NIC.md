# Add Suricata (PCI Passthrough NIC)

---
After initial installation it is recommended to get a snapshot if everything working as expected (Debian 13, ELK stack, Wazuh Manager).
---

Poweroff the system and add the second NIC to Hardware in Proxmox settings.
Add --> PCI device --> Choose Raw device and find your device for dropdown list
Add the device and power on the system

## Verify PCI passthrough NIC is correct (CRITICAL)

**Run**
```bash
ip addr
```

**You should see:**
eth0 (or similar) → has IP
eth1 (or similar) → NO IP

Verify link state:
```
ip link show eth1
```

Bring it UP if is down (no IP):
```
sudo ip link set eth1 up
```

# Install Suricata
```bash
sudo apt update
sudo apt install -y suricata
```

**Check version - we want Suricata 7.x or later and AF_PACKET support
```
suricata --build-info | head -n 5
```

## Disable before config
```bash
sudo systemctl stop suricata
sudo systemctl disable suricata
```

## Edit suricata.yml
---
**Optional Configure as below - Mandatory: set af-packet interfaece, pcap interface**

```yaml
outputs:
  - fast:
      enabled: no

  - eve-log:
      enabled: yes
      filetype: regular
      filename: /var/log/suricata/eve.json

      pcap-file: false

      community-id: true
      community-id-seed: 0

      xff:
        enabled: no

      types:
        - alert:
            tagged-packets: no

        - dns:
          enabled: yes
          version: 2
          # requests: yes  # Enable if too much noise
          # responses: no  # Enable if too much noise
        - tls:
          extended: no
        - ssh
        - dhcp:
          enabled: no
        - mqtt:
          passwords: no

        - stats:
          totals: no
          threads: no
          deltas: no
        - http:
            extended: no

        - flow:
            enabled: yes
            log-flow-start: false

af-packet:
  - interface: <NIC-2-Interface name>
    cluster-id: 99
    cluster-type: cluster_flow
    defrag: yes
    use-mmap: yes
    ring-size: 200000
# Cross platform libpcap capture support
pcap:
  - interface: <NIC-2-Interface name>
```

## Get IDS signatures (ET Open) using suricata-update
**Right now you only have the “events” rules. For actual detections, do:**

a) Update sources index
```bash
sudo suricata-update update-sources
```
b) Enable ET Open (free, standard)
```
sudo suricata-update enable-source et/open
```

c) Download and build rules
```
sudo suricata-update
```
**This produces a combined rules file in /var/lib/suricata/rules/ (often suricata.rules).**

## Start Suricata in live mode

```
sudo systemctl enable suricata
sudo systemctl start suricata
```

**Confirm it’s running:**

```
sudo systemctl status suricata --no-pager
```

## Validate configuration file
```
sudo suricata -T -c /etc/suricata/suricata.yaml -i <NIC-2 Interface name>
```

## Check traffic on monitor NIC
```
sudo tcpdump -i <NIC-2-Interface name> -c 30
```

# Ingest data with Logstash into Elasticsearch

## Set permissions with acl so Logstash can read EVE - if suricata group exists just add logstash user to suricata group
```
sudo setfacl -m u:logstash:rX /var/log/suricata
sudo setfacl -m u:logstash:r /var/log/suricata/eve.json
sudo setfacl -d -m u:logstash:rX /var/log/suricata
```

# Create Logstash pipeline
```
sudo nano /etc/logstash/conf.d/suricata.conf
```

**Configuration**
```
input {
  file {
    path => "/var/log/suricata/eve.json"
    mode => "tail"
    start_position => "end"
    sincedb_path => "/var/lib/logstash/suricata.sincedb"
    stat_interval => 1

    codec => json {
      target => "suricata"
      ecs_compatibility => "disabled"
    }

    type => "suricata"
  }
}

filter {
  if [type] == "suricata" {

    # Suricata EVE uses "timestamp" at top of its JSON object.
    if [suricata][timestamp] {
      date {
        match => ["[suricata][timestamp]", "ISO8601"]
        target => "@timestamp"
        remove_field => ["[suricata][timestamp]"]
      }
    }

    # Optional: add a lightweight tag for easier filtering
    mutate {
      add_tag => ["source_suricata"]
    }

    # Optional: drop super-noisy event types if you ever re-enable them
    # if [suricata][event_type] == "stats" { drop {} }
  }
}

output {
  if [type] == "suricata" {
    elasticsearch {
      hosts => ["https://localhost:9200"]
      index => "suricata-events-%{+YYYY.MM.dd}"

      user => "elastic"
      password => "YOUR_ELASTIC_PASSWORD"

      ssl_enabled => true
      ssl_certificate_authorities => ["/etc/logstash/http_ca.crt"]
      ssl_verification_mode => "full"
    }
  }
}

```

## Restart Logstash and watch for any errors
```
sudo systemctl restart logstash
sudo journalctl -u logstash -n 50 --no-pager
```

## Check if index exists
```
sudo curl --cacert /etc/kibana/http_ca.crt -u elastic https://localhost:9200/_cat/indices/suricata-events-*?v
```

## Create Kibana Data View for Suricata

In Kibana:

Stack Management → Data Views → Create data view

- Name: Suricata Events

- Index pattern: suricata-events-*

- Time field: @timestamp

Then go to Discover and filter:

- suricata.event_type : alert

- suricata.event_type : dns

- suricata.community_id : *
